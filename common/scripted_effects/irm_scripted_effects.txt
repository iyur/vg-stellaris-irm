# IRM: Imperial Routine Mod
# Author: Iyur
# Mod custom scripted effects & routines

# This = System / Sector
# Get key stats for the chosen scope
irm_get_stats = {
	set_variable = { which = irm_owned_colonies value = value:irm_planets_|owned|y| }
	set_variable = { which = irm_habitable value = value:irm_planets_|habitable|y| }
	root.owner = {
		every_system_within_border = {
			limit = {
				exists = sector
				sector = { is_same_value = prevprevprev }
			}
			prevprev = { change_variable = { which = irm_trade_value value = prev.trigger:has_system_trade_value } }
			# planet loop
			every_system_planet = {
				irm_get_stats_demography = yes
				irm_get_stats_resources = yes
			}
			# starbases
			starbase.fleet = {
				# energy upkeep
				switch = {
					trigger = is_ship_size
						starbase_outpost = { prevprevprev = { change_variable = { which = irm_energy_starbase_exp value = 1 } } }
						starbase_starport = { prevprevprev = { change_variable = { which = irm_energy_starbase_exp value = 2 } } }
						starbase_starhold = { prevprevprev = { change_variable = { which = irm_energy_starbase_exp value = 3 } } }
						starbase_starfortress = { prevprevprev = { change_variable = { which = irm_energy_starbase_exp value = 4 } } }
						starbase_citadel = { prevprevprev = { change_variable = { which = irm_energy_starbase_exp value = 5 } } }
				}
			}
		} # system
	}
	# final calculations
	if = {
		# averages
		limit = { check_variable = { which = irm_owned_colonies value > 0 } }
			divide_variable = { which = irm_stability value = irm_owned_colonies }
			divide_variable = { which = irm_crime value = irm_owned_colonies }
			divide_variable = { which = irm_happiness value = irm_owned_colonies }
			multiply_variable = { which = irm_happiness value = 100 }
	}
	# research
	change_variable = { which = irm_research value = irm_physics_research }
	change_variable = { which = irm_research value = irm_society_research }
	change_variable = { which = irm_research value = irm_engineering_research }
	# strategic
	change_variable = { which = irm_strategic value = irm_volatile_motes }
	change_variable = { which = irm_strategic value = irm_exotic_gases }
	change_variable = { which = irm_strategic value = irm_rare_crystals }
	change_variable = { which = irm_strategic value = irm_sr_living_metal }
	change_variable = { which = irm_strategic value = irm_sr_zro }
	change_variable = { which = irm_strategic value = irm_sr_dark_matter }
	change_variable = { which = irm_strategic value = irm_nanites }
	change_variable = { which = irm_strategic value = irm_minor_artifacts }
	if = {
		# starbases upkeep
		limit = { check_variable = { which = irm_energy_starbase_exp value > 0 } }
			subtract_variable = { which = irm_energy value = irm_energy_starbase_exp }
	}
	# roundings
	round_variable = irm_stability
	round_variable = irm_crime
	round_variable = irm_happiness

	round_variable = irm_trade_value
	round_variable = irm_energy
	round_variable = irm_minerals
	round_variable = irm_food
	round_variable = irm_consumer_goods
	round_variable = irm_alloys
	round_variable = irm_unity
	round_variable = irm_research
	round_variable = irm_strategic
	round_variable = irm_influence
}

# This = Planet
irm_get_stats_demography = {
	if = {
		limit = {
			exists = owner
			owner = { is_same_value = root.owner }
			is_under_colonization = no
		}
		prevprevprev = {
			change_variable = { which = irm_pops value = prev.trigger:num_pops }
			change_variable = { which = irm_stability value = prev.trigger:planet_stability }
			change_variable = { which = irm_crime value = prev.trigger:planet_crime }
			change_variable = { which = irm_housing value = prev.trigger:free_housing }
			change_variable = { which = irm_amenities value = prev.trigger:free_amenities }
			change_variable = { which = irm_jobs value = prev.trigger:free_jobs }
			change_variable = { which = irm_unemployed value = prev.trigger:num_unemployed }
			change_variable = { which = irm_happiness value = prev.trigger:happiness_planet }
		}
	}
}
irm_get_stats_resources = {
	if = {
		# for owned
		limit = {
			exists = owner
			owner = { is_same_value = root.owner }
			is_under_colonization = no
		}
		prevprevprev = {
			irm_get_resource_breakdown = { resource = energy planet = yes }
			irm_get_resource_breakdown = { resource = minerals planet = yes }
			irm_get_resource_breakdown = { resource = food planet = yes }
			irm_get_resource_breakdown = { resource = consumer_goods planet = yes }
			irm_get_resource_breakdown = { resource = alloys planet = yes }
			irm_get_resource_breakdown = { resource = unity planet = yes }
			irm_get_resource_breakdown = { resource = physics_research planet = yes }
			irm_get_resource_breakdown = { resource = society_research planet = yes }
			irm_get_resource_breakdown = { resource = engineering_research planet = yes }
			irm_get_resource_breakdown = { resource = influence planet = yes }
			# strategic
			irm_get_resource_breakdown = { resource = volatile_motes planet = yes }
			irm_get_resource_breakdown = { resource = exotic_gases planet = yes }
			irm_get_resource_breakdown = { resource = rare_crystals planet = yes }
			irm_get_resource_breakdown = { resource = sr_living_metal planet = yes }
			irm_get_resource_breakdown = { resource = sr_zro planet = yes }
			irm_get_resource_breakdown = { resource = sr_dark_matter planet = yes }
			irm_get_resource_breakdown = { resource = nanites planet = yes }
			irm_get_resource_breakdown = { resource = minor_artifacts planet = yes }
		}
		# capital case
		if = {
			limit = { is_same_value = root.owner.capital_scope }
			prevprevprev = {
				change_variable = { which = irm_energy value = 20 }
				change_variable = { which = irm_energy_base_inc value = 20 }
				change_variable = { which = irm_minerals value = 20 }
				change_variable = { which = irm_minerals_base_inc value = 20 }
				change_variable = { which = irm_food value = 10 }
				change_variable = { which = irm_food_base_inc value = 10 }
				change_variable = { which = irm_consumer_goods value = 10 }
				change_variable = { which = irm_consumer_goods_base_inc value = 10 }
				change_variable = { which = irm_alloys value = 5 }
				change_variable = { which = irm_alloys_base_inc value = 5 }
				change_variable = { which = irm_unity value = 5 }
				change_variable = { which = irm_unity_base_inc value = 5 }
				change_variable = { which = irm_physics_research value = 10 }
				change_variable = { which = irm_physics_research_base_inc value = 10 }
				change_variable = { which = irm_society_research value = 10 }
				change_variable = { which = irm_society_research_base_inc value = 10 }
				change_variable = { which = irm_engineering_research value = 10 }
				change_variable = { which = irm_engineering_research_base_inc value = 10 }
				change_variable = { which = irm_influence value = 3 }
				change_variable = { which = irm_influence_base_inc value = 3 }
			}
		}
	}
	if = {
		# for just resourceful
		limit = {
			is_colony = no
			has_owner = no
			has_resource = yes
			or = {
				has_mining_station = yes
				has_research_station = yes
				has_observation_outpost = yes
			}
		}
		prevprevprev = {
			irm_get_resource_breakdown = { resource = energy station = yes }
			irm_get_resource_breakdown = { resource = minerals station = yes }
			irm_get_resource_breakdown = { resource = alloys station = yes }
			irm_get_resource_breakdown = { resource = unity station = yes }
			irm_get_resource_breakdown = { resource = physics_research station = yes }
			irm_get_resource_breakdown = { resource = society_research station = yes }
			irm_get_resource_breakdown = { resource = engineering_research station = yes }
			# strategic
			irm_get_resource_breakdown = { resource = volatile_motes station = yes }
			irm_get_resource_breakdown = { resource = exotic_gases station = yes }
			irm_get_resource_breakdown = { resource = rare_crystals station = yes }
			irm_get_resource_breakdown = { resource = sr_living_metal station = yes }
			irm_get_resource_breakdown = { resource = sr_zro station = yes }
			irm_get_resource_breakdown = { resource = sr_dark_matter station = yes }
			irm_get_resource_breakdown = { resource = nanites station = yes }
			irm_get_resource_breakdown = { resource = minor_artifacts station = yes }
		}
		# non-energy stations upkeep
		if = {
			limit = { has_resource = { type = energy amount = 0 } }
			prevprevprev = {
				change_variable = { which = irm_energy value = -1 }
				change_variable = { which = irm_energy_station_exp value = 1 }
			}
		}
	}
}

# This = System / Sector
# Clears all variables
irm_del_stats = {
	irm_unset = { which = irm_owned_colonies }
	irm_unset = { which = irm_habitable }
	# demography
	irm_unset = { which = irm_pops }
	irm_unset = { which = irm_stability }
	irm_unset = { which = irm_crime }
	irm_unset = { which = irm_housing }
	irm_unset = { which = irm_amenities }
	irm_unset = { which = irm_jobs }
	irm_unset = { which = irm_unemployed }
	irm_unset = { which = irm_happiness }
	# resources
	irm_unset = { which = irm_trade_value }
	irm_unset = { which = irm_energy }
	irm_unset = { which = irm_energy_base_inc }
	irm_unset = { which = irm_energy_planet_exp }
	irm_unset = { which = irm_energy_planet_inc }
	irm_unset = { which = irm_energy_station_exp }
	irm_unset = { which = irm_energy_station_inc }
	irm_unset = { which = irm_energy_starbase_exp }
	irm_unset = { which = irm_minerals }
	irm_unset = { which = irm_minerals_base_inc }
	irm_unset = { which = irm_minerals_planet_exp }
	irm_unset = { which = irm_minerals_planet_inc }
	irm_unset = { which = irm_food }
	irm_unset = { which = irm_food_base_inc }
	irm_unset = { which = irm_food_planet_exp }
	irm_unset = { which = irm_food_planet_inc }
	irm_unset = { which = irm_food_starbase_inc }
	irm_unset = { which = irm_food_starbase_mod }
	irm_unset = { which = irm_consumer_goods }
	irm_unset = { which = irm_consumer_goods_base_inc }
	irm_unset = { which = irm_consumer_goods_planet_exp }
	irm_unset = { which = irm_consumer_goods_planet_inc }
	irm_unset = { which = irm_alloys }
	irm_unset = { which = irm_alloys_base_inc }
	irm_unset = { which = irm_alloys_station_inc }
	irm_unset = { which = irm_alloys_planet_exp }
	irm_unset = { which = irm_unity }
	irm_unset = { which = irm_unity_base_inc }
	irm_unset = { which = irm_unity_station_inc }
	irm_unset = { which = irm_unity_planet_exp }
	irm_unset = { which = irm_unity_planet_inc }
	irm_unset = { which = irm_physics_research }
	irm_unset = { which = irm_physics_research_base_inc }
	irm_unset = { which = irm_physics_research_station_inc }
	irm_unset = { which = irm_physics_research_planet_inc }
	irm_unset = { which = irm_society_research }
	irm_unset = { which = irm_society_research_base_inc }
	irm_unset = { which = irm_society_research_station_inc }
	irm_unset = { which = irm_society_research_planet_inc }
	irm_unset = { which = irm_engineering_research }
	irm_unset = { which = irm_engineering_research_base_inc }
	irm_unset = { which = irm_engineering_research_station_inc }
	irm_unset = { which = irm_engineering_research_planet_inc }
	irm_unset = { which = irm_research }
	irm_unset = { which = irm_influence }
	irm_unset = { which = irm_influence_base_inc }
	irm_unset = { which = irm_influence_planet_inc }
	irm_unset = { which = irm_strategic }
	irm_unset = { which = irm_volatile_motes }
	irm_unset = { which = irm_volatile_motes_station_inc }
	irm_unset = { which = irm_volatile_motes_planet_exp }
	irm_unset = { which = irm_volatile_motes_planet_inc }
	irm_unset = { which = irm_exotic_gases }
	irm_unset = { which = irm_exotic_gases_station_inc }
	irm_unset = { which = irm_exotic_gases_planet_exp }
	irm_unset = { which = irm_exotic_gases_planet_inc }
	irm_unset = { which = irm_rare_crystals }
	irm_unset = { which = irm_rare_crystals_station_inc }
	irm_unset = { which = irm_rare_crystals_planet_exp }
	irm_unset = { which = irm_rare_crystals_planet_inc }
	irm_unset = { which = irm_sr_living_metal }
	irm_unset = { which = irm_sr_living_metal_station_inc }
	irm_unset = { which = irm_sr_living_metal_planet_exp }
	irm_unset = { which = irm_sr_living_metal_planet_inc }
	irm_unset = { which = irm_sr_zro }
	irm_unset = { which = irm_sr_zro_station_inc }
	irm_unset = { which = irm_sr_zro_planet_exp }
	irm_unset = { which = irm_sr_zro_planet_inc }
	irm_unset = { which = irm_sr_dark_matter }
	irm_unset = { which = irm_sr_dark_matter_station_inc }
	irm_unset = { which = irm_sr_dark_matter_planet_exp }
	irm_unset = { which = irm_sr_dark_matter_planet_inc }
	irm_unset = { which = irm_nanites }
	irm_unset = { which = irm_nanites_station_inc }
	irm_unset = { which = irm_nanites_planet_exp }
	irm_unset = { which = irm_nanites_planet_inc }
	irm_unset = { which = irm_minor_artifacts }
	irm_unset = { which = irm_minor_artifacts_station_inc }
	irm_unset = { which = irm_minor_artifacts_planet_exp }
	irm_unset = { which = irm_minor_artifacts_planet_inc }
}